<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makbuz Oluşturma Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDK v11.6.1 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, updateDoc, deleteDoc, doc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global değişkenleri (Canvas ortamından sağlanır)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId; // Kimliği doğrulanmış kullanıcı ID'si veya rastgele bir ID

        // Firestore ve Auth'u başlat
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase kimlik doğrulaması başarılı. Kullanıcı ID:", userId);
                    loadPaymentsFromFirestore(); // Kimlik doğrulandıktan sonra ödemeleri yükle
                } else {
                    // Token yoksa veya kullanıcı çıkış yaptıysa anonim olarak oturum aç
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase kimlik doğrulaması başarısız:", error);
                        alert("Firebase kimlik doğrulaması başarısız oldu. Bazı özellikler çalışmayabilir.");
                        userId = crypto.randomUUID(); // Fallback: rastgele bir ID ata
                        loadPaymentsFromFirestore(); // Yine de ödemeleri yüklemeye çalış
                    }
                }
            });
        } else {
            console.warn("Firebase yapılandırması bulunamadı. Çevrimdışı modda çalışılıyor.");
            userId = crypto.randomUUID(); // Çevrimdışı kullanım için rastgele ID
            // payments dizisi zaten global olarak tanımlı, yerel olarak çalışmaya devam edecek.
            // loadRecentPayments() DOMContentLoaded içinde zaten çağrılıyor.
        }

        // Global erişim için gerekli fonksiyonları window objesine ekle
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.userId = userId; // Henüz tanımlanmamış olabilir, onAuthStateChanged içinde güncellenecek
        window.generateReceiptId = generateReceiptId; // Makbuz ID oluşturma fonksiyonu
        window.loadPaymentsFromFirestore = loadPaymentsFromFirestore; // Ödemeleri Firestore'dan yükleme fonksiyonu
        window.addDoc = addDoc;
        window.collection = collection;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.onSnapshot = onSnapshot;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.getDocs = getDocs;
        window.runTransaction = runTransaction;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Inter fontunu yükle */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            background-color: #ffffff; /* Beyaz arka plan */
            padding: 2.5rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Hafif gölge */
            width: 100%;
            max-width: 64rem; /* max-w-4xl */
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            color: #1f2937; /* Tailwind gray-800 */
            margin-bottom: 1.5rem;
            font-weight: 700; /* font-bold */
        }

        input[type="text"],
        input[type="number"],
        input[type="tel"],
        textarea, /* textarea için stil eklendi */
        select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-sizing: border-box;
            font-size: 1rem;
            color: #374151; /* Tailwind gray-700 */
        }

        textarea {
            resize: vertical; /* Sadece dikey yeniden boyutlandırma */
            /* min-height kaldırıldı, rows özniteliği kontrol edecek */
        }

        button {
            background-color: #2563eb; /* Tailwind blue-600 */
            color: white;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s ease-in-out;
        }

        button:hover {
            background-color: #1d4ed8; /* Tailwind blue-700 */
        }

        .btn-secondary {
            background-color: #6b7280; /* Tailwind gray-500 */
        }

        .btn-secondary:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
        }

        .btn-danger {
            background-color: #dc2626; /* Tailwind red-600 */
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* Tailwind red-700 */
        }

        .btn-success {
            background-color: #10b981; /* Tailwind green-500 */
        }
        .btn-success:hover {
            background-color: #059669; /* Tailwind green-600 */
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
            flex-wrap: wrap; /* Küçük ekranlarda sarmalama */
        }

        .hidden {
            display: none !important; /* !important tekrar eklendi */
        }

        .payment-item {
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #f9fafb; /* Tailwind gray-50 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .payment-item p {
            margin: 0.25rem 0;
            color: #4b5563; /* Tailwind gray-600 */
        }

        .payment-item strong {
            color: #1f2937; /* Tailwind gray-800 */
        }

        /* Makbuz Görünümü Stilleri */
        #receiptDisplay {
            background-color: #fff;
            border: 1px dashed #9ca3af; /* Tailwind gray-400 */
            padding: 1.5rem;
            margin-top: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 400px; /* Makbuz genişliği */
            margin-left: auto;
            margin-right: auto;
        }

        #receiptDisplay h3 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1f2937;
        }

        #receiptDisplay p {
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        #receiptDisplay .receipt-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        #receiptDisplay .receipt-total {
            font-size: 1.1rem;
            font-weight: 600;
            border-top: 1px solid #d1d5db;
            padding-top: 0.75rem;
            margin-top: 1rem;
        }

        #receiptDisplay .receipt-footer {
            text-align: center;
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 1.5rem;
        }

        /* Modal Stilleri */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }

        .modal-close-button:hover {
            color: #1f2937;
        }

        /* PDF Oluşturma ve Yazdırma için Gizli Konteyner Stilleri */
        #pdfPrintContainer {
            position: absolute; /* Ekran dışında konumlandır */
            left: -9999px;
            top: -9999px;
            width: 210mm; /* A4 genişliği */
            height: 297mm; /* A4 yüksekliği */
            padding: 10mm; /* Kenar boşlukları */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-around; /* Makbuzları dikeyde eşit dağıt */
            align-items: center;
            z-index: -1; /* Diğer içeriğin altında kalmasını sağla */
            visibility: hidden; /* HTML2PDF'in yakalaması için gizli ama render edilebilir */
            opacity: 0; /* Tamamen şeffaf */
        }
        #pdfPrintContainer .receipt-item-for-pdf {
            width: 100%;
            max-width: 148mm; /* Yaklaşık A5 genişliği */
            border: 1px dashed #9ca3af;
            padding: 10mm;
            margin-bottom: 5mm; /* İki makbuz arası boşluk */
            box-sizing: border-box;
            page-break-inside: avoid; /* Makbuzun ortadan bölünmemesini sağlar */
        }
        #pdfPrintContainer .receipt-item-for-pdf:last-child {
            margin-bottom: 0;
        }
        #pdfPrintContainer .receipt-item-for-pdf.cutting-line {
            border-bottom: 1px dashed #6b7280; /* Kesme çizgisi */
            padding-bottom: 15mm; /* Çizgi altı boşluk */
            margin-bottom: 15mm; /* Çizgi altı boşluk */
        }
        #pdfPrintContainer .receipt-item-for-pdf h3 {
            font-size: 1.2rem;
        }
        #pdfPrintContainer .receipt-item-for-pdf p {
            font-size: 0.8rem;
        }
        #pdfPrintContainer .receipt-item-for-pdf .receipt-total {
            font-size: 0.9rem;
        }


        /* Yazdırma için özel stil */
        @media print {
            body * {
                visibility: hidden;
            }
            /* Sadece PDF konteynerini yazdır */
            #pdfPrintContainer, #pdfPrintContainer * {
                visibility: visible;
            }
            #pdfPrintContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                height: 297mm;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                align-items: center;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-start min-h-screen p-8">
    <div class="container bg-white p-10 rounded-lg shadow-xl w-full max-w-4xl">
        <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Makbuz Oluşturma Sistemi</h1>

        <!-- Ana İşlem Butonları -->
        <div class="btn-group mb-8">
            <button id="addPaymentButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 hidden">
                Ödeme Ekle
            </button>
            <button id="allPaymentsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-md transition duration-200">
                Tüm Ödemeler
            </button>
            <button id="settingsButton" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-md transition duration-200">
                Ayarlar
            </button>
        </div>

        <!-- Ödeme Ekleme Formu -->
        <div id="paymentForm" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Yeni Ödeme Ekle</h2>
            <input type="text" id="payerName" placeholder="Ödeme Yapan Kişi Adı Soyadı" class="block w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="text" id="childName" placeholder="Çocuk Adı Soyadı (Opsiyonel)" class="block w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <textarea id="paymentDescription" placeholder="Ödeme Açıklaması" rows="2" class="block w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <input type="number" id="paymentAmount" placeholder="Ödeme Tutarı" class="block w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="tel" id="phoneNumber" placeholder="Telefon Numarası (Örn: 5xx xxx xx xx)" class="block w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select id="paymentMethod" class="block w-full p-3 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Nakit">Nakit</option>
                <option value="Kredi Kartı">Kredi Kartı</option>
            </select>
            <div class="btn-group">
                <button id="savePaymentButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-md transition duration-200">Kaydet ve Makbuz Oluştur</button>
                <button id="cancelPaymentButton" class="btn-secondary bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-md transition duration-200">İptal</button>
            </div>
        </div>

        <!-- Makbuz Oluşturuldu Aksiyonları -->
        <div id="receiptActions" class="hidden text-center mt-6 no-print">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Makbuz Oluşturuldu!</h2>
            <div class="btn-group">
                <button id="shareMainButton" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-md transition duration-200">Paylaş</button>
                <!-- PDF İndir butonu buraya taşındı -->
                <button id="newPaymentButton" class="btn-secondary bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-md transition duration-200">Yeni Ödeme Ekle</button>
            </div>
        </div>

        <!-- Makbuz Görüntüleme Alanı -->
        <div id="receiptDisplay" class="hidden mt-8">
            <!-- Makbuz içeriği buraya JavaScript ile yüklenecek -->
        </div>

        <!-- Son Eklenen Ödemeler -->
        <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-4">Son Eklenen Ödemeler</h2>
        <div id="recentPayments" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Ödemeler buraya JavaScript ile yüklenecek -->
            <p id="noPaymentsMessage" class="col-span-full text-center text-gray-500">Henüz ödeme eklenmedi.</p>
        </div>
    </div>

    <!-- Tüm Ödemeler Modalı (Eski "Tüm Ödemeler ve Raporlar" modalının sadece ödemeler kısmı) -->
    <div id="allPaymentsModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="closeAllPaymentsModalButton">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Tüm Ödeme Kayıtları</h2>
            <div id="allPaymentsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p id="noAllPaymentsMessage" class="col-span-full text-center text-gray-500">Henüz ödeme eklenmedi.</p>
            </div>
        </div>
    </div>

    <!-- Ayarlar Modalı -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="closeSettingsModalButton">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Ayarlar</h2>

            <!-- Başlık Oluşturma Alanı -->
            <div class="mb-8 p-4 bg-blue-50 rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-blue-800 mb-3">Makbuz Başlığı Oluştur</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="customTitleInput" placeholder="Makbuz Başlığını Buraya Girin" class="flex-grow p-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="setCustomTitleButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">Başlığı Ayarla</button>
                </div>
            </div>

            <!-- Aylık Rapor Kontrolleri -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-yellow-800 mb-3">Aylık Rapor Al</h3>
                <div class="flex flex-col sm:flex-row gap-3 items-center">
                    <select id="reportMonth" class="p-2 border border-yellow-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 flex-grow">
                        <!-- Aylar JavaScript ile doldurulacak -->
                    </select>
                    <select id="reportYear" class="p-2 border border-yellow-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 flex-grow">
                        <!-- Yıllar JavaScript ile doldurulacak -->
                    </select>
                    <button id="generateReportButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">Raporu Göster</button>
                </div>
                <div id="monthlyReportOutput" class="mt-4 p-3 bg-white border border-yellow-200 rounded-md hidden">
                    <!-- Aylık rapor buraya gelecek -->
                </div>
            </div>

            <!-- Ödeme Kayıtlarını Sil Butonu -->
            <div class="mb-6 p-4 bg-red-50 rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-red-800 mb-3">Ödeme Kayıtlarını Sil</h3>
                <button id="clearPaymentsButton" class="btn-danger bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 w-full">
                    Tüm Ödeme Kayıtlarını Sil
                </button>
            </div>
        </div>
    </div>

    <!-- Paylaşım Seçenekleri Modalı -->
    <div id="shareOptionsModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="closeShareOptionsModalButton">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Makbuzu Paylaş</h2>
            <div class="btn-group flex-col">
                <!-- PDF Olarak İndir butonu buraya taşındı -->
                <button id="shareModalDownloadPdfButton" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 w-full mb-3">PDF Olarak İndir</button>
                <button id="shareModalWhatsappButton" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 w-full mb-3">WhatsApp ile Paylaş (Metin)</button>
                <button id="shareModalMailButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 w-full mb-3">E-posta ile Paylaş</button>
                <button id="shareModalPrintButton" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-md transition duration-200 w-full">Yazdır</button>
            </div>
        </div>
    </div>

    <!-- PDF oluşturmak için gizli konteyner -->
    <div id="pdfPrintContainer"></div>

    <script type="module">
        // Firebase modülleri window objesine eklendiği için burada tekrar import etmeye gerek yok.
        // Ancak, IDE'ler için tip denetimi sağlamak adına yorum satırı olarak bırakılabilir.
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, updateDoc, deleteDoc, doc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ödemeleri geçici olarak saklayacak dizi
        let payments = [];
        // Özel başlık
        let customTitle = "Makbuz Oluşturma Sistemi";

        // Şifreler
        const savePassword = '5210';
        const clearPassword = '1052';

        // Global variable to store the payment data for the currently displayed receipt
        let currentReceiptForShare = null;

        // Makbuz numarası oluşturma fonksiyonu
        // Firestore'dan son numarayı okur ve günceller
        async function generateReceiptId() {
            const db = window.db;
            const appId = window.appId;

            if (!db) {
                console.warn("Firestore başlatılmadı. Yerel makbuz ID'si oluşturuluyor.");
                // Fallback to local storage logic if Firestore is not available
                let lastReceiptNumber = parseInt(localStorage.getItem('lastReceiptNumber')) || 999;
                let lastReceiptMonthYear = localStorage.getItem('lastReceiptMonthYear') || '';

                const today = new Date();
                const currentMonthYear = `${today.getMonth()}-${today.getFullYear()}`;
                if (currentMonthYear !== lastReceiptMonthYear) {
                    lastReceiptNumber = 1000;
                    lastReceiptMonthYear = currentMonthYear;
                } else {
                    lastReceiptNumber++;
                }
                localStorage.setItem('lastReceiptNumber', lastReceiptNumber.toString());
                localStorage.setItem('lastReceiptMonthYear', currentMonthYear);
                return lastReceiptNumber;
            }

            const counterRef = window.doc(db, `artifacts/${appId}/public/data/receipt_counters/current_month`);
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            try {
                const newReceiptId = await window.runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let currentCounter = 999; // Varsayılan değer, eğer sayaç yoksa 1000'den başlar
                    let storedMonth = -1;
                    let storedYear = -1;

                    if (counterDoc.exists()) {
                        const data = counterDoc.data();
                        currentCounter = data.lastNumber || 999;
                        storedMonth = data.month;
                        storedYear = data.year;
                    }

                    if (storedMonth !== currentMonth || storedYear !== currentYear) {
                        // Yeni ay/yıl, sayacı sıfırla
                        currentCounter = 1000;
                        transaction.set(counterRef, { lastNumber: 1000, month: currentMonth, year: currentYear });
                    } else {
                        // Aynı ay/yıl, sayacı artır
                        currentCounter++;
                        transaction.update(counterRef, { lastNumber: currentCounter });
                    }
                    return currentCounter;
                });
                return newReceiptId;
            } catch (e) {
                console.error("Makbuz ID oluşturma başarısız oldu:", e);
                alert("Makbuz numarası oluşturulurken bir hata oluştu. Lütfen tekrar deneyin.");
                return Date.now(); // Firestore hatası durumunda zaman damgası kullan
            }
        }

        // Ödemeleri Firestore'dan yükleme
        function loadPaymentsFromFirestore() {
            const db = window.db;
            const appId = window.appId;
            const allPaymentsModal = document.getElementById('allPaymentsModal');

            if (!db) {
                console.warn("Firestore başlatılmadı. Ödemeler Firestore'dan yüklenemiyor.");
                loadRecentPayments(); // Yerel diziden yükle
                return;
            }

            const paymentsColRef = window.collection(db, `artifacts/${appId}/public/data/payments`);
            // fullDate ISO string olarak saklandığı için sıralama yapılabilir
            const q = window.query(paymentsColRef, window.orderBy('fullDate', 'desc'));

            window.onSnapshot(q, (snapshot) => {
                payments = [];
                snapshot.forEach((docItem) => {
                    const data = docItem.data();
                    // fullDate ISO string'den Date objesine dönüştür
                    data.fullDate = data.fullDate ? new Date(data.fullDate) : new Date();
                    data.firestoreId = docItem.id; // Firestore belge ID'sini sakla
                    payments.push(data);
                });
                loadRecentPayments(); // Son ödemeler ekranını güncelle
                // Eğer tüm ödemeler modalı açıksa, onu da güncelle
                if (!allPaymentsModal.classList.contains('hidden')) {
                    loadAllPayments();
                }
            }, (error) => {
                console.error("Ödemeler Firestore'dan alınırken hata oluştu:", error);
                alert("Ödemeler yüklenirken bir hata oluştu.");
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            const mainTitle = document.getElementById('mainTitle');
            const customTitleInput = document.getElementById('customTitleInput');
            const setCustomTitleButton = document.getElementById('setCustomTitleButton');
            const addPaymentButton = document.getElementById('addPaymentButton');
            const allPaymentsButton = document.getElementById('allPaymentsButton');
            const settingsButton = document.getElementById('settingsButton'); 
            const paymentForm = document.getElementById('paymentForm');
            const savePaymentButton = document.getElementById('savePaymentButton');
            const cancelPaymentButton = document.getElementById('cancelPaymentButton');
            const recentPaymentsDiv = document.getElementById('recentPayments');
            const noPaymentsMessage = document.getElementById('noPaymentsMessage');
            const receiptDisplay = document.getElementById('receiptDisplay');
            const receiptActions = document.getElementById('receiptActions');
            const shareMainButton = document.getElementById('shareMainButton'); // Paylaş butonu
            const newPaymentButton = document.getElementById('newPaymentButton');

            const allPaymentsModal = document.getElementById('allPaymentsModal');
            const closeAllPaymentsModalButton = document.getElementById('closeAllPaymentsModalButton'); 
            const allPaymentsList = document.getElementById('allPaymentsList');
            const noAllPaymentsMessage = document.getElementById('noAllPaymentsMessage');
            
            const settingsModal = document.getElementById('settingsModal'); 
            const closeSettingsModalButton = document.getElementById('closeSettingsModalButton'); 
            const reportMonthSelect = document.getElementById('reportMonth');
            const reportYearSelect = document.getElementById('reportYear');
            const generateReportButton = document.getElementById('generateReportButton');
            const monthlyReportOutput = document.getElementById('monthlyReportOutput');
            const clearPaymentsButton = document.getElementById('clearPaymentsButton'); 

            const shareOptionsModal = document.getElementById('shareOptionsModal'); // Paylaşım seçenekleri modalı
            const closeShareOptionsModalButton = document.getElementById('closeShareOptionsModalButton');
            const shareModalDownloadPdfButton = document.getElementById('shareModalDownloadPdfButton'); // PDF İndir butonu
            const shareModalWhatsappButton = document.getElementById('shareModalWhatsappButton');
            const shareModalMailButton = document.getElementById('shareModalMailButton');
            const shareModalPrintButton = document.getElementById('shareModalPrintButton');

            const pdfPrintContainer = document.getElementById('pdfPrintContainer'); // PDF için gizli konteyner

            // Sayfa yüklendiğinde tüm modalları ve aksiyon alanlarını gizle
            allPaymentsModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            receiptActions.classList.add('hidden');
            receiptDisplay.classList.add('hidden');
            shareOptionsModal.classList.add('hidden');
            
            // Sadece ödeme formunu göster
            paymentForm.classList.remove('hidden'); 
            addPaymentButton.classList.add('hidden'); 
            
            // Firebase başlatıldığında ödemeler otomatik yüklenecek
            // Eğer Firebase config yoksa, yerel yükleme devreye girer.
            if (!window.firebaseConfig) {
                loadRecentPayments(); // Sadece Firebase yoksa yerel yükleme yap
            }


            // Tüm ana içerik alanlarını gizleyen ve isteneni gösteren yardımcı fonksiyon
            function showSection(sectionId) {
                // Tüm ana içerik alanlarını gizle
                paymentForm.classList.add('hidden');
                receiptDisplay.classList.add('hidden');
                receiptActions.classList.add('hidden');
                allPaymentsModal.classList.add('hidden');
                settingsModal.classList.add('hidden');
                shareOptionsModal.classList.add('hidden'); // Paylaşım modalını da gizle

                // İstenen bölümü göster
                document.getElementById(sectionId).classList.remove('hidden');

                // addPaymentButton'ın görünürlüğünü yönet
                if (sectionId === 'paymentForm') {
                    addPaymentButton.classList.add('hidden'); // Ödeme formu açıksa gizle
                } else {
                    addPaymentButton.classList.remove('hidden'); // Diğer bölümler açıksa göster
                }
            }

            // Başlık ayarla
            setCustomTitleButton.addEventListener('click', () => {
                const newTitle = customTitleInput.value.trim();
                if (newTitle) {
                    customTitle = newTitle;
                    mainTitle.textContent = customTitle;
                    alert('Başlık başarıyla güncellendi!');
                } else {
                    alert('Lütfen bir başlık girin.');
                }
            });

            // Ödeme Ekle butonu
            addPaymentButton.addEventListener('click', () => {
                showSection('paymentForm');
            });

            // Formu iptal et
            cancelPaymentButton.addEventListener('click', () => {
                showSection('paymentForm'); // İptal edince ödeme formuna geri dön
                clearForm();
            });

            // Yeni ödeme ekle butonuna basınca formu tekrar aç
            newPaymentButton.addEventListener('click', () => {
                showSection('paymentForm'); // Yeni ödeme ekle deyince ödeme formuna geri dön
                clearForm(); // Formu temizle
            });

            // Ödemeyi kaydet ve makbuz oluştur
            savePaymentButton.addEventListener('click', async () => { // async eklendi
                const enteredPassword = prompt("Makbuz oluşturmak için şifreyi girin:");
                if (enteredPassword !== savePassword) {
                    alert("Yanlış şifre! Makbuz oluşturulamadı.");
                    // Önceki ekrana dönmek için formu tekrar göster
                    showSection('paymentForm');
                    return;
                }

                const payerName = document.getElementById('payerName').value.trim();
                const childName = document.getElementById('childName').value.trim();
                const paymentDescription = document.getElementById('paymentDescription').value.trim();
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentDate = new Date(); // Bugünün tarihi

                if (!payerName || isNaN(paymentAmount) || paymentAmount <= 0 || !phoneNumber) {
                    alert('Lütfen tüm zorunlu alanları (Ödeme Yapan Kişi, Tutar, Telefon Numarası) doğru şekilde doldurun.');
                    return;
                }

                const paymentData = {
                    id: await generateReceiptId(), // Benzersiz ID için yeni fonksiyonu kullan
                    payerName,
                    childName: childName || 'Belirtilmedi',
                    paymentDescription: paymentDescription || 'Yok',
                    paymentAmount,
                    phoneNumber,
                    paymentMethod,
                    paymentDate: paymentDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    paymentTime: paymentDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                    fullDate: paymentDate.toISOString() // Raporlama ve sıralama için ISO string olarak sakla
                };

                if (window.db && window.appId) { // Firebase başlatıldıysa
                    try {
                        const docRef = await window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/payments`), paymentData);
                        console.log("Belge şu ID ile yazıldı: ", docRef.id);
                        paymentData.firestoreId = docRef.id; // Firestore belge ID'sini sakla
                    } catch (e) {
                        console.error("Belge eklenirken hata oluştu: ", e);
                        alert("Ödeme kaydedilirken bir hata oluştu. Lütfen tekrar deneyin.");
                        return; // Kaydetme başarısız olursa dur
                    }
                } else {
                    // Firebase yoksa yerel payments dizisine ekle
                    payments.unshift(paymentData);
                }

                loadRecentPayments(); // Ödemeleri yeniden yükle
                clearForm(); // Formu temizle
                
                // Makbuzu göster ve aksiyon butonlarını göster
                displayReceipt(paymentData);
                showSection('receiptActions'); // Makbuz aksiyonlarını göster
                receiptDisplay.classList.remove('hidden'); // Makbuz görüntüsünü göster
            });

            // Son eklenen ödemeleri yükle
            function loadRecentPayments() {
                recentPaymentsDiv.innerHTML = ''; // Önceki ödemeleri temizle
                if (payments.length === 0) {
                    noPaymentsMessage.classList.remove('hidden');
                } else {
                    noPaymentsMessage.classList.add('hidden');
                    // Sadece son 5 ödemeyi göster
                    payments.slice(0, 5).forEach(payment => {
                        const paymentItem = document.createElement('div');
                        paymentItem.classList.add('payment-item', 'rounded-lg', 'shadow-sm', 'bg-gray-50', 'p-4');
                        paymentItem.innerHTML = `
                            <p class="text-gray-700"><strong>Ödeyen:</strong> ${payment.payerName}</p>
                            <p class="text-gray-700"><strong>Çocuk:</strong> ${payment.childName}</p>
                            <p class="text-gray-700"><strong>Tutar:</strong> ${payment.paymentAmount.toFixed(2)} TL</p>
                            <p class="text-gray-700"><strong>Açıklama:</strong> ${payment.paymentDescription}</p>
                            <p class="text-gray-700"><strong>Ödeme Şekli:</strong> ${payment.paymentMethod}</p>
                            <p class="text-gray-700"><strong>Tarih:</strong> ${payment.paymentDate} ${payment.paymentTime}</p>
                        `;
                        recentPaymentsDiv.appendChild(paymentItem);
                    });
                }
            }

            // Formu temizle
            function clearForm() {
                document.getElementById('payerName').value = '';
                document.getElementById('childName').value = '';
                document.getElementById('paymentDescription').value = '';
                document.getElementById('paymentAmount').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('paymentMethod').value = 'Nakit';
            }

            // Makbuzu HTML olarak oluştur ve göster
            function displayReceipt(payment) {
                receiptDisplay.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">${customTitle}</h3>
                    <div class="mb-4">
                        <p class="receipt-line"><span><strong>Makbuz No:</strong></span> <span>#${payment.id}</span></p>
                        <p class="receipt-line"><span><strong>Tarih:</strong></span> <span>${payment.paymentDate} ${payment.paymentTime}</span></p>
                    </div>
                    <div class="mb-4">
                        <p class="text-lg font-semibold text-gray-700 mb-2">Ödeyen Bilgileri:</p>
                        <p class="receipt-line"><span><strong>Adı Soyadı:</strong></span> <span>${payment.payerName}</span></p>
                        <p class="receipt-line"><span><strong>Telefon:</strong></span> <span>${payment.phoneNumber}</span></p>
                        ${payment.childName !== 'Belirtilmedi' ? `<p class="receipt-line"><span><strong>Çocuk Adı:</strong></span> <span>${payment.childName}</span></p>` : ''}
                    </div>
                    <div class="mb-4">
                        <p class="text-lg font-semibold text-gray-700 mb-2">Ödeme Bilgileri:</p>
                        <p class="receipt-line"><span><strong>Açıklama:</strong></span> <span>${payment.paymentDescription}</span></p>
                        <p class="receipt-line"><span><strong>Ödeme Şekli:</strong></span> <span>${payment.paymentMethod}</span></p>
                    </div>
                    <div class="receipt-total text-xl font-bold text-gray-900">
                        <p class="receipt-line"><span>Toplam Tutar:</span> <span>${payment.paymentAmount.toFixed(2)} TL</span></p>
                    </div>
                    <p class="receipt-footer text-gray-600 mt-6">Teşekkür ederiz!</p>
                `;
            }

            // Function to generate receipt HTML for PDF/Print
            function getReceiptHtmlContent(payment, isForPrint = false) {
                const cuttingLineClass = isForPrint ? 'cutting-line' : '';
                return `
                    <div class="receipt-item-for-pdf ${cuttingLineClass}">
                        <h3 class="text-center font-bold mb-2 text-gray-800">${customTitle}</h3>
                        <div class="mb-2">
                            <p class="receipt-line"><span><strong>Makbuz No:</strong></span> <span>#${payment.id}</span></p>
                            <p class="receipt-line"><span><strong>Tarih:</strong></span> <span>${payment.paymentDate} ${payment.paymentTime}</span></p>
                        </div>
                        <div class="mb-2">
                            <p class="text-sm font-semibold text-gray-700 mb-1">Ödeyen Bilgileri:</p>
                            <p class="receipt-line"><span><strong>Adı Soyadı:</strong></span> <span>${payment.payerName}</span></p>
                            <p class="receipt-line"><span><strong>Telefon:</strong></span> <span>${payment.phoneNumber}</span></p>
                            ${payment.childName !== 'Belirtilmedi' ? `<p class="receipt-line"><span><strong>Çocuk Adı:</strong></span> <span>${payment.childName}</span></p>` : ''}
                        </div>
                        <div class="mb-2">
                            <p class="text-sm font-semibold text-gray-700 mb-1">Ödeme Bilgileri:</p>
                            <p class="receipt-line"><span><strong>Açıklama:</strong></span> <span>${payment.paymentDescription}</span></p>
                            <p class="receipt-line"><span><strong>Ödeme Şekli:</strong></span> <span>${payment.paymentMethod}</span></p>
                        </div>
                        <div class="receipt-total text-base font-bold text-gray-900">
                            <p class="receipt-line"><span>Toplam Tutar:</span> <span>${payment.paymentAmount.toFixed(2)} TL</span></p>
                        </div>
                        <p class="text-center text-xs text-gray-600 mt-2">Teşekkür ederiz!</p>
                    </div>
                `;
            }

            // Function to handle PDF generation and printing
            async function generatePdfAndOrPrint(action, paymentData) {
                if (!paymentData) {
                    alert('PDF oluşturulacak veya yazdırılacak bir makbuz bulunmuyor.');
                    return;
                }

                if (action === 'download') {
                    // Populate the hidden container with receipt content
                    pdfPrintContainer.innerHTML = getReceiptHtmlContent(paymentData);
                    // Temporarily make it visible for html2pdf to capture
                    pdfPrintContainer.style.visibility = 'visible';
                    pdfPrintContainer.style.opacity = '1';

                    const opt = {
                        margin:       10,
                        filename:     `makbuz_${paymentData.id}.pdf`,
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2, logging: true, dpi: 300, letterRendering: true },
                        jsPDF:        { unit: 'mm', format: 'a5', orientation: 'portrait' }
                    };
                    
                    // Add a small delay to ensure the content is rendered by the browser
                    await new Promise(resolve => setTimeout(resolve, 100)); 

                    try {
                        await html2pdf().set(opt).from(pdfPrintContainer).save();
                    } catch (error) {
                        console.error("PDF oluşturulurken hata oluştu:", error);
                        alert("PDF oluşturulurken bir hata oluştu. Lütfen konsolu kontrol edin.");
                    } finally {
                        // Hide the container again and clear content
                        pdfPrintContainer.style.visibility = 'hidden';
                        pdfPrintContainer.style.opacity = '0';
                        pdfPrintContainer.innerHTML = '';
                    }

                } else if (action === 'print') {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write('<html><head><title>Makbuz Yazdır</title>');
                    printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">');
                    printWindow.document.write('<style>');
                    printWindow.document.write(`
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; justify-content: space-around; align-items: center; min-height: 297mm; }
                        .receipt-item-for-pdf {
                            width: 148mm; /* A5 genişliği */
                            border: 1px dashed #9ca3af;
                            padding: 10mm;
                            margin-bottom: 10mm; /* Makbuzlar arası boşluk */
                            box-sizing: border-box;
                            page-break-inside: avoid;
                        }
                        .receipt-item-for-pdf:last-child { margin-bottom: 0; }
                        .receipt-item-for-pdf.cutting-line {
                            border-bottom: 1px dashed #6b7280; /* Kesme çizgisi */
                            padding-bottom: 15mm;
                            margin-bottom: 15mm;
                        }
                        .receipt-item-for-pdf h3 { text-align: center; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; color: #1f2937; }
                        .receipt-item-for-pdf p { margin-bottom: 0.25rem; font-size: 0.8rem; line-height: 1.2; }
                        .receipt-item-for-pdf .receipt-line { display: flex; justify-content: space-between; }
                        .receipt-item-for-pdf .receipt-total { font-size: 0.9rem; font-weight: 600; border-top: 1px solid #d1d5db; padding-top: 0.5rem; margin-top: 0.75rem; }
                        .receipt-item-for-pdf .receipt-footer { text-align: center; font-size: 0.7rem; color: #6b7280; margin-top: 0.75rem; }
                    `);
                    printWindow.document.write('</style>');
                    printWindow.document.write('</head><body>');
                    // İlk makbuz ve kesme çizgisi
                    printWindow.document.write(getReceiptHtmlContent(paymentData, true)); 
                    // İkinci makbuz
                    printWindow.document.write(getReceiptHtmlContent(paymentData)); 
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.focus();
                    printWindow.print();
                }
            }

            // WhatsApp ile paylaş (metin olarak)
            function sendWhatsAppReceipt(payment) {
                const message = `*${customTitle}*\n` +
                                `-----------------------------------\n` +
                                `Makbuz No: #${payment.id}\n` +
                                `Tarih: ${payment.paymentDate} ${payment.paymentTime}\n` +
                                `Ödeyen Kişi: ${payment.payerName}\n` +
                                `Çocuk Adı: ${payment.childName}\n` +
                                `Ödeme Tutarı: ${payment.paymentAmount.toFixed(2)} TL\n` +
                                `Ödeme Açıklaması: ${payment.paymentDescription}\n` +
                                `Ödeme Şekli: ${payment.paymentMethod}\n` +
                                `-----------------------------------\n` +
                                `Teşekkür ederiz!`;

                let whatsappNum = payment.phoneNumber.replace(/\s/g, ''); // Boşlukları kaldır
                if (whatsappNum.startsWith('0')) {
                    whatsappNum = '90' + whatsappNum.substring(1); // 0'ı kaldırıp 90 ekle
                } else if (!whatsappNum.startsWith('90')) {
                    whatsappNum = '90' + whatsappNum; // Başında 90 yoksa ekle (Basit varsayım)
                }
                
                const whatsappUrl = `https://wa.me/${whatsappNum}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            // E-posta ile paylaş
            function sendEmailReceipt(payment) {
                const subject = encodeURIComponent(`${customTitle} - Makbuz No: #${payment.id}`);
                const body = encodeURIComponent(
                    `Sayın ${payment.payerName},\n\n` +
                    `Ödemeniz başarıyla alınmıştır. İşte makbuz bilgileriniz:\n\n` +
                    `-----------------------------------\n` +
                    `Makbuz No: #${payment.id}\n` +
                    `Tarih: ${payment.paymentDate} ${payment.paymentTime}\n` +
                    `Ödeyen Kişi: ${payment.payerName}\n` +
                    `Çocuk Adı: ${payment.childName}\n` +
                    `Ödeme Tutarı: ${payment.paymentAmount.toFixed(2)} TL\n` +
                    `Ödeme Açıklaması: ${payment.paymentDescription}\n` +
                    `Ödeme Şekli: ${payment.paymentMethod}\n` +
                    `-----------------------------------\n\n` +
                    `Teşekkür ederiz!`
                );
                window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
            }

            // Paylaşım seçenekleri modalını göster
            function showShareOptionsModal(payment) {
                currentReceiptForShare = payment; // Paylaşılacak makbuzu global değişkene ata
                shareOptionsModal.classList.remove('hidden');
            }

            // Ana makbuz ekranındaki Paylaş butonu
            shareMainButton.addEventListener('click', () => {
                if (payments.length > 0) {
                    showShareOptionsModal(payments[0]); // En son oluşturulan makbuzu paylaş
                } else {
                    alert('Paylaşılacak bir makbuz bulunmuyor.');
                }
            });

            // Paylaşım modalındaki PDF İndir butonu
            shareModalDownloadPdfButton.addEventListener('click', () => { 
                generatePdfAndOrPrint('download', currentReceiptForShare);
                shareOptionsModal.classList.add('hidden');
            });

            shareModalWhatsappButton.addEventListener('click', () => {
                const confirmTextShare = confirm("WhatsApp üzerinden doğrudan PDF dosyası gönderilememektedir. Makbuz bilgilerini metin olarak paylaşmak ister misiniz?");
                if (confirmTextShare) {
                    sendWhatsAppReceipt(currentReceiptForShare);
                }
                shareOptionsModal.classList.add('hidden');
            });

            shareModalMailButton.addEventListener('click', () => {
                sendEmailReceipt(currentReceiptForShare);
                shareOptionsModal.classList.add('hidden');
            });

            shareModalPrintButton.addEventListener('click', () => {
                generatePdfAndOrPrint('print', currentReceiptForShare); 
                shareOptionsModal.classList.add('hidden');
            });

            closeShareOptionsModalButton.addEventListener('click', () => {
                shareOptionsModal.classList.add('hidden');
            });


            // Tüm Ödemeler Butonu
            allPaymentsButton.addEventListener('click', () => {
                showSection('allPaymentsModal');
                loadAllPayments();
            });

            // Tüm Ödemeler Modalı kapatma
            closeAllPaymentsModalButton.addEventListener('click', () => {
                showSection('paymentForm'); // Modalı kapatınca ödeme formuna geri dön
            });

            // Tüm ödemeleri modalda listele
            function loadAllPayments() {
                allPaymentsList.innerHTML = '';
                if (payments.length === 0) {
                    noAllPaymentsMessage.classList.remove('hidden');
                } else {
                    noAllPaymentsMessage.classList.add('hidden');
                    payments.forEach(payment => {
                        const paymentItem = document.createElement('div');
                        paymentItem.classList.add('payment-item', 'rounded-lg', 'shadow-sm', 'bg-gray-50', 'p-4', 'flex', 'flex-col', 'justify-between');
                        paymentItem.innerHTML = `
                            <div>
                                <p class="text-gray-700"><strong>Ödeyen:</strong> ${payment.payerName}</p>
                                <p class="text-gray-700"><strong>Tutar:</strong> ${payment.paymentAmount.toFixed(2)} TL</p>
                                <p class="text-gray-700"><strong>Tarih:</strong> ${payment.paymentDate} ${payment.paymentTime}</p>
                                <p class="text-gray-700"><strong>Açıklama:</strong> ${payment.paymentDescription}</p>
                            </div>
                            <button class="share-individual-button bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md mt-4 transition duration-200" data-payment-id="${payment.id}">Paylaş</button>
                        `;
                        allPaymentsList.appendChild(paymentItem);
                    });

                    // Her bir ödeme öğesi için paylaş butonuna olay dinleyici ekle
                    document.querySelectorAll('.share-individual-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const paymentId = parseInt(event.target.dataset.paymentId);
                            const paymentToShare = payments.find(p => p.id === paymentId);
                            if (paymentToShare) {
                                showShareOptionsModal(paymentToShare);
                            }
                        });
                    });
                }
            }

            // Ayarlar Butonu
            settingsButton.addEventListener('click', () => {
                showSection('settingsModal');
                // Ayarlar modalı açıldığında aylık rapor seçicilerini doldur
                populateMonthYearSelectors();
                monthlyReportOutput.classList.add('hidden'); // Rapor çıktısını gizle
            });

            // Ayarlar Modalı kapatma
            closeSettingsModalButton.addEventListener('click', () => {
                showSection('paymentForm'); // Modalı kapatınca ödeme formuna geri dön
            });

            // Ay ve Yıl Seçicilerini Doldur
            function populateMonthYearSelectors() {
                reportMonthSelect.innerHTML = '';
                reportYearSelect.innerHTML = '';

                const months = [
                    "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran",
                    "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"
                ];
                const currentYear = new Date().getFullYear();

                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index; // 0-11 arası ay indeksi
                    option.textContent = month;
                    reportMonthSelect.appendChild(option);
                });

                for (let i = currentYear - 5; i <= currentYear + 1; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === currentYear) {
                        option.selected = true;
                    }
                    reportYearSelect.appendChild(option);
                }
                reportMonthSelect.value = new Date().getMonth(); // Mevcut ayı seçili yap
            }

            // Rapor Oluştur Butonu (Ayarlar modalı içinde)
            generateReportButton.addEventListener('click', () => {
                const selectedMonth = parseInt(reportMonthSelect.value);
                const selectedYear = parseInt(reportYearSelect.value);

                // Seçeneklerin varlığını ve geçerliliğini kontrol et
                if (isNaN(selectedMonth) || isNaN(selectedYear) || reportMonthSelect.options.length === 0) {
                    monthlyReportOutput.innerHTML = `<p class="text-red-600">Ay veya yıl seçimi geçersiz. Lütfen tekrar deneyin.</p>`;
                    monthlyReportOutput.classList.remove('hidden');
                    return;
                }
                
                const filteredPayments = payments.filter(payment => {
                    const paymentDate = payment.fullDate;
                    return paymentDate.getMonth() === selectedMonth && paymentDate.getFullYear() === selectedYear;
                });

                let totalAmount = 0;
                let reportHtml = `<h3 class="text-lg font-semibold text-gray-800 mb-2">${reportMonthSelect.options[reportMonthSelect.selectedIndex].text} ${selectedYear} Ayı Raporu</h3>`;
                
                if (filteredPayments.length === 0) {
                    reportHtml += `<p class="text-gray-600">Bu ay için ödeme bulunmamaktadır.</p>`;
                } else {
                    reportHtml += `<ul class="list-disc pl-5 text-gray-700">`;
                    filteredPayments.forEach(payment => {
                        totalAmount += payment.paymentAmount;
                        reportHtml += `<li>${payment.payerName} - ${payment.paymentAmount.toFixed(2)} TL (${payment.paymentMethod}) - ${payment.paymentDate}</li>`;
                    });
                    reportHtml += `</ul>`;
                    reportHtml += `<p class="text-lg font-bold text-gray-900 mt-4">Toplam Gelir: ${totalAmount.toFixed(2)} TL</p>`;
                }
                monthlyReportOutput.innerHTML = reportHtml;
                monthlyReportOutput.classList.remove('hidden');
            });

            // Ödeme Kayıtlarını Sil Butonu (Ayarlar modalı içinde)
            clearPaymentsButton.addEventListener('click', async () => { // async eklendi
                const enteredPassword = prompt("Tüm ödeme kayıtlarını silmek için şifreyi girin:");
                if (enteredPassword !== clearPassword) {
                    alert("Yanlış şifre! Kayıtlar silinemedi.");
                    return;
                }

                if (confirm('Tüm ödeme kayıtlarını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
                    if (window.db && window.appId) { // Firebase başlatıldıysa
                        try {
                            const paymentsColRef = window.collection(window.db, `artifacts/${window.appId}/public/data/payments`);
                            const snapshot = await window.getDocs(paymentsColRef); // Tüm belgeleri al
                            const deletePromises = [];
                            snapshot.forEach((docItem) => {
                                deletePromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/payments`, docItem.id)));
                            });
                            await Promise.all(deletePromises); // Tüm silme işlemlerini bekle
                            alert('Tüm ödeme kayıtları başarıyla silindi.');
                        } catch (e) {
                            console.error("Belgeler silinirken hata oluştu: ", e);
                            alert("Kayıtlar silinirken bir hata oluştu.");
                        }
                    } else {
                        payments = []; // Firebase yoksa yerel diziyi sıfırla
                        alert('Tüm ödeme kayıtları silindi (yerel).');
                    }
                    loadRecentPayments(); // Ana sayfadaki listeyi güncelle
                    loadAllPayments(); // Modal'daki listeyi güncelle
                    monthlyReportOutput.classList.add('hidden'); // Rapor çıktısını gizle
                }
            });

            // Sayfa yüklendiğinde son ödemeleri göster (eğer varsa)
            // Firebase başlatıldığında loadPaymentsFromFirestore çağrılır.
            // Eğer Firebase yoksa, bu fonksiyon local'den yükler.
            if (!window.firebaseConfig) { // Sadece Firebase yoksa DOMContentLoaded'da yükle
                loadRecentPayments();
            }
        });
    </script>
</body>
</html>
